{"version":3,"file":"emailService-6vz86vpM.js","sources":["../../services/emailService.ts"],"sourcesContent":["/**\n * Email Service\n * Handles email functionality using mailto: links and Web Share API\n * All processing happens client-side for privacy\n */\n\nimport { LogEntry, Goal, ValueItem, LCSWConfig } from '../types';\n\nexport interface EmailData {\n  subject: string;\n  body: string;\n  attachments?: Array<{ name: string; content: string; type: string }>;\n}\n\n/**\n * Check if Web Share API is available (mobile devices)\n */\nexport function isWebShareAvailable(): boolean {\n  return typeof navigator !== 'undefined' && 'share' in navigator;\n}\n\n/**\n * Share content using Web Share API (mobile) or fallback to mailto:\n */\nexport async function shareViaEmail(\n  emailData: EmailData,\n  recipientEmails: string[] = []\n): Promise<boolean> {\n  try {\n    // Try Web Share API first (mobile devices)\n    if (isWebShareAvailable()) {\n      const shareData: ShareData = {\n        title: emailData.subject,\n        text: emailData.body,\n      };\n\n      // Web Share API doesn't support email directly, but we can share the content\n      // User can then choose to email it\n      try {\n        await navigator.share(shareData);\n        return true;\n      } catch (error: any) {\n        // User cancelled or share failed, fallback to mailto\n        if (error.name !== 'AbortError') {\n          console.warn('Web Share failed, using mailto fallback:', error);\n        }\n      }\n    }\n\n    // Fallback to mailto: link\n    return openMailtoLink(emailData, recipientEmails);\n  } catch (error) {\n    console.error('Email share error:', error);\n    return false;\n  }\n}\n\n/**\n * Open mailto: link with pre-filled email\n */\nfunction openMailtoLink(emailData: EmailData, recipientEmails: string[]): boolean {\n  try {\n    const to = recipientEmails.length > 0 ? recipientEmails.join(',') : '';\n    const subject = encodeURIComponent(emailData.subject);\n    const body = encodeURIComponent(emailData.body);\n    \n    const mailtoLink = `mailto:${to}?subject=${subject}&body=${body}`;\n    window.location.href = mailtoLink;\n    return true;\n  } catch (error) {\n    console.error('Mailto link error:', error);\n    return false;\n  }\n}\n\n/**\n * Generate email report from logs\n */\nexport function generateEmailReport(\n  logs: LogEntry[],\n  values: ValueItem[],\n  reportText?: string\n): EmailData {\n  const dateRange = logs.length > 0\n    ? `${new Date(logs[logs.length - 1].date).toLocaleDateString()} - ${new Date(logs[0].date).toLocaleDateString()}`\n    : 'No date range';\n\n  const subject = `Grounded Therapy Integration Report - ${dateRange}`;\n\n  let body = reportText || '';\n\n  if (!body) {\n    // Generate basic summary if no report text provided\n    body = `Grounded by AC MiNDS - Therapy Integration Summary\\n\\n`;\n    body += `Date Range: ${dateRange}\\n`;\n    body += `Total Entries: ${logs.length}\\n\\n`;\n    \n    if (logs.length > 0) {\n      body += `Recent Activity:\\n`;\n      logs.slice(0, 10).forEach(log => {\n        const value = values.find(v => v.id === log.valueId);\n        let entry = `\\n- ${new Date(log.date).toLocaleDateString()}: ${value?.name || 'General'}`;\n        if (log.deepReflection) {\n          entry += `\\n  Deep Reflection: ${log.deepReflection.substring(0, 150)}${log.deepReflection.length > 150 ? '...' : ''}`;\n        }\n        if (log.reflectionAnalysis) {\n          entry += `\\n  Analysis: ${log.reflectionAnalysis.substring(0, 200)}${log.reflectionAnalysis.length > 200 ? '...' : ''}`;\n        }\n        entry += `\\n  Note: ${log.note.substring(0, 100)}${log.note.length > 100 ? '...' : ''}\\n`;\n        body += entry;\n      });\n    }\n  }\n\n  body += `\\n\\n---\\n`;\n  body += `This report was generated by Grounded by AC MiNDS, a privacy-first therapy integration app.\\n`;\n  body += `All data processing happens on-device. This report is for sharing with your LCSW.\\n`;\n\n  return { subject, body };\n}\n\n/**\n * Generate email summary of goals and updates\n */\nexport function generateGoalsEmail(\n  goals: Goal[],\n  values: ValueItem[],\n  completedGoals: Goal[]\n): EmailData {\n  const subject = `Grounded Goals Update - ${new Date().toLocaleDateString()}`;\n\n  let body = `Grounded by AC MiNDS - Goals & Progress Update\\n\\n`;\n  body += `Date: ${new Date().toLocaleDateString()}\\n\\n`;\n\n  if (completedGoals.length > 0) {\n    body += `âœ… Completed Goals:\\n`;\n    completedGoals.forEach(goal => {\n      const value = values.find(v => v.id === goal.valueId);\n      body += `\\n- ${value?.name || 'General'}: ${goal.text}\\n`;\n      if (goal.updates.length > 0) {\n        body += `  Updates: ${goal.updates.length}\\n`;\n      }\n    });\n    body += `\\n`;\n  }\n\n  if (goals.filter(g => !g.completed).length > 0) {\n    body += `ðŸ“‹ Active Goals:\\n`;\n    goals.filter(g => !g.completed).forEach(goal => {\n      const value = values.find(v => v.id === goal.valueId);\n      body += `\\n- ${value?.name || 'General'}: ${goal.text}\\n`;\n      body += `  Frequency: ${goal.frequency}\\n`;\n      body += `  Updates: ${goal.updates.length}\\n`;\n    });\n  }\n\n  body += `\\n\\n---\\n`;\n  body += `This update was generated by Grounded by AC MiNDS.\\n`;\n\n  return { subject, body };\n}\n\n/**\n * Generate comprehensive data export email\n */\nexport function generateDataExportEmail(\n  logs: LogEntry[],\n  goals: Goal[],\n  values: ValueItem[],\n  settings: any\n): EmailData {\n  const subject = `Grounded Complete Data Export - ${new Date().toLocaleDateString()}`;\n\n  let body = `Grounded by AC MiNDS - Complete Data Export\\n\\n`;\n  body += `Export Date: ${new Date().toISOString()}\\n`;\n  body += `Total Logs: ${logs.length}\\n`;\n  body += `Total Goals: ${goals.length}\\n`;\n  body += `Active Values: ${values.length}\\n\\n`;\n\n  body += `=== LOGS ===\\n\\n`;\n  if (logs.length === 0) {\n    body += `No logs recorded.\\n\\n`;\n  } else {\n    logs.forEach(log => {\n      const value = values.find(v => v.id === log.valueId);\n      body += `[${new Date(log.date).toLocaleDateString()}] ${value?.name || 'General'}\\n`;\n      body += `Mood: ${log.mood || 'N/A'}\\n`;\n      body += `Note: ${log.note}\\n`;\n      if (log.goalText) {\n        body += `Related Goal: ${log.goalText}\\n`;\n      }\n      body += `\\n`;\n    });\n  }\n\n  body += `=== GOALS ===\\n\\n`;\n  if (goals.length === 0) {\n    body += `No goals set.\\n\\n`;\n  } else {\n    goals.forEach(goal => {\n      const value = values.find(v => v.id === goal.valueId);\n      body += `${goal.completed ? 'âœ…' : 'ðŸ“‹'} ${value?.name || 'General'}\\n`;\n      body += `Goal: ${goal.text}\\n`;\n      body += `Frequency: ${goal.frequency}\\n`;\n      body += `Created: ${new Date(goal.createdAt).toLocaleDateString()}\\n`;\n      if (goal.updates.length > 0) {\n        body += `Updates:\\n`;\n        goal.updates.forEach(update => {\n          body += `  - ${new Date(update.timestamp).toLocaleDateString()}: ${update.note}\\n`;\n        });\n      }\n      body += `\\n`;\n    });\n  }\n\n  body += `\\n---\\n`;\n  body += `This export contains all your Grounded data.\\n`;\n  body += `Keep this email secure and only share with trusted healthcare providers.\\n`;\n\n  return { subject, body };\n}\n\n/**\n * Schedule email summary (stores schedule locally)\n */\nexport interface EmailSchedule {\n  enabled: boolean;\n  frequency: 'daily' | 'weekly' | 'monthly';\n  time: string; // HH:mm format\n  recipientEmails: string[];\n  lastSent?: string;\n}\n\nexport function saveEmailSchedule(userId: string, schedule: EmailSchedule): void {\n  localStorage.setItem(`emailSchedule_${userId}`, JSON.stringify(schedule));\n}\n\nexport function getEmailSchedule(userId: string): EmailSchedule | null {\n  const stored = localStorage.getItem(`emailSchedule_${userId}`);\n  return stored ? JSON.parse(stored) : null;\n}\n\n/**\n * Check if it's time to send scheduled email\n */\nexport function shouldSendScheduledEmail(schedule: EmailSchedule): boolean {\n  if (!schedule.enabled) return false;\n\n  const now = new Date();\n  const lastSent = schedule.lastSent ? new Date(schedule.lastSent) : null;\n  const [scheduleHour, scheduleMin] = schedule.time.split(':').map(Number);\n  const currentHour = now.getHours();\n  const currentMin = now.getMinutes();\n\n  // Check if current time matches scheduled time\n  if (currentHour !== scheduleHour || currentMin !== scheduleMin) {\n    return false;\n  }\n\n  // Check frequency\n  if (!lastSent) return true; // Never sent, send now\n\n  const daysSinceLastSent = Math.floor((now.getTime() - lastSent.getTime()) / (1000 * 60 * 60 * 24));\n\n  switch (schedule.frequency) {\n    case 'daily':\n      return daysSinceLastSent >= 1;\n    case 'weekly':\n      return daysSinceLastSent >= 7;\n    case 'monthly':\n      return daysSinceLastSent >= 30;\n    default:\n      return false;\n  }\n}\n"],"names":["isWebShareAvailable","navigator","async","shareViaEmail","emailData","recipientEmails","shareData","title","subject","text","body","share","error","name","to","length","join","mailtoLink","encodeURIComponent","window","location","href","openMailtoLink","generateEmailReport","logs","values","reportText","dateRange","Date","date","toLocaleDateString","slice","forEach","log","value","find","v","id","valueId","entry","deepReflection","substring","reflectionAnalysis","note","generateGoalsEmail","goals","completedGoals","goal","updates","filter","g","completed","frequency","generateDataExportEmail","settings","toISOString","mood","goalText","createdAt","update","timestamp","saveEmailSchedule","userId","schedule","localStorage","setItem","JSON","stringify"],"mappings":"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"}